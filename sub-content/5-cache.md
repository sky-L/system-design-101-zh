
## 缓存

### 数据无处不缓存

这张图说明了在典型架构中我们会在哪些地方缓存数据。

<p>
  <img src="images/where do we cache data.jpeg" style="width: 720px" />
</p>



在数据流中有**多个层次**。

1. 客户端应用程序：浏览器可以缓存 HTTP 响应。我们第一次通过 HTTP 请求数据时，会在 HTTP 头中返回一个过期策略；我们再次请求数据时，客户端应用程序会首先尝试从浏览器缓存中检索数据。
2. CDN：CDN 缓存静态网络资源。客户端可以从附近的 CDN 节点检索数据。
3. 负载均衡器：负载均衡器也可以缓存资源。
4. 消息基础设施：消息代理首先将消息存储在磁盘上，然后消费者按自己的节奏检索消息。根据保留策略，数据在 Kafka 集群中缓存一段时间。
5. 服务：服务中有多个层次的缓存。如果数据未缓存在 CPU 缓存中，服务将尝试从内存中检索数据。有时服务还有第二级缓存，用于将数据存储在磁盘上。
6. 分布式缓存：像 Redis 这样的分布式缓存在内存中保存多个服务的键值对。它比数据库提供更好的读写性能。
7. 全文搜索：我们有时需要使用全文搜索，如 Elastic Search 用于文档搜索或日志搜索。数据的副本也被索引在搜索引擎中。
8. 数据库：即使在数据库中，我们也有不同级别的缓存：

- WAL（预写式日志）：在构建 B 树索引之前，数据首先写入 WAL。
- 缓冲池：分配给缓存查询结果的内存区域。
- 材料化视图：预先计算查询结果并将其存储在数据库表中，以获得更好的查询性能。
- 事务日志：记录所有事务和数据库更新。
- 复制日志：用于记录数据库集群中的复制状态。

### redis 为何如此快速

如下图所示，有三个主要原因。

<p>
  <img src="images/why_redis_fast.jpeg" />
</p>


1. Redis 是基于 RAM 的数据存储。与随机磁盘访问相比，RAM 访问速度至少快 1000 倍。
2. Redis 利用 IO 多路复用和单线程执行循环以提高执行效率。
3. Redis 利用了几种高效的低级数据结构。

问题：另一个流行的内存存储是 Memcached。您知道 Redis 和 Memcached 之间的区别吗？

您可能已经注意到这张图表的风格与我之前的帖子不同。请告诉我您更喜欢哪一个。

### redis 可以如何使用

<p>
  <img src="images/top-redis-use-cases.jpg" style="width: 520px" />
</p>


Redis 不仅仅是缓存。

Redis 可以在各种场景中使用，如下图所示。

- 会话

  我们可以使用 Redis 在不同的服务之间共享用户会话数据。

- 缓存

  我们可以使用 Redis 缓存对象或页面，特别是热点数据。

- 分布式锁

  我们可以使用 Redis 字符串在分布式服务之间获取锁。

- 计数器

  我们可以计算文章的点赞数或阅读量。

- 速率限制器

  我们可以为特定用户 IP 应用速率限制器。

- 全局 ID 生成器

  我们可以使用 Redis Int 作为全局 ID。

- 购物车

  我们可以使用 Redis Hash 表示购物车中的键值对。

- 计算用户留存

  我们可以使用 Bitmap 表示用户每天的登录情况，并计算用户留存。

- 消息队列

  我们可以使用 List 作为消息队列。

- 排名

  我们可以使用 ZSet 对文章进行排序。

### 顶级缓存策略

设计大规模系统通常需要仔细考虑缓存。以下是经常使用的五种缓存策略

<p>
  <img src="images/top_caching_strategy.jpeg" style="width: 680px" />
</p>