
## 微服务架构

### 典型的微服务架构是什么样子的


下图显示了典型的微服务架构。

<p>
  <img src="images/typical-microservice-arch.jpg" style="width: 520px" />
</p>

- 负载均衡器：将传入的流量分发到多个后端服务。
- CDN（内容分发网络）：CDN 是一组地理分布的服务器，保存静态内容以便更快地传递。客户端首先在 CDN 中查找内容，然后转到后端服务。
- API 网关：处理传入的请求并将它们路由到相关服务。它与身份提供者和服务发现进行通信。
- 身份提供者：处理用户的身份验证和授权。
- 服务注册表和发现：微服务的注册和发现发生在此组件中，API 网关在此组件中查找相关服务以进行通信。
- 管理：此组件负责监视服务。
- 微服务：微服务在不同的域中设计和部署。每个域都有自己的数据库。API 网关通过 REST API 或其他协议与微服务进行通信，同一域内的微服务使用 RPC（远程过程调用）相互通信。


微服务的好处：

- 可以快速设计、部署和水平扩展。
- 每个域可以由专门的团队独立维护。
- 由于每个域都可以定制业务需求并得到更好的支持，因此业务需求可以在每个域中得到更好的支持。

### 微服务最佳实践

一图胜千言：开发微服务的 9 个最佳实践。
<p>
  <img src="images/microservice-best-practices.jpeg" />
</p>


当我们开发微服务时，需要遵循以下最佳实践：

1. 为每个微服务使用单独的数据存储
2. 保持代码处于相似的成熟度水平
3. 为每个微服务分别构建
4. 为每个微服务分配单一职责
5. 部署到容器中
6. 设计无状态服务
7. 采用领域驱动设计
8. 设计微前端
9. 编排微服务

### 常用于微服务的技术栈是什么

以下是显示微服务技术栈的图表，包括开发阶段和生产阶段。


<p>
  <img src="images/microservice-tech.jpeg" />
</p>


▶️ 𝐏𝐫𝐞-𝐏𝐫𝐨𝐝𝐮𝐜𝐭𝐢𝐨𝐧

- 定义 API - 这建立了前端和后端之间的契约。我们可以使用 Postman 或 OpenAPI 来实现。
- 开发 - Node.js 或 React 用于前端开发，Java/Python/Go 用于后端开发。此外，我们需要根据 API 定义更改 API 网关的配置。
- 持续集成 - JUnit 和 Jenkins 用于自动化测试。代码被打包成 Docker 镜像并部署为微服务。

▶️ 𝐏𝐫𝐨𝐝𝐮𝐜𝐭𝐢𝐨𝐧
 
- NGinx 是负载均衡器的常见选择。Cloudflare 提供 CDN（Content Delivery Network 内容分发网络）。
- API 网关 - 我们可以使用 Spring Boot 作为网关，并使用 Eureka/Zookeeper 进行服务发现。
- 微服务部署在云上。我们可以选择 AWS、Microsoft Azure 或 Google GCP。
  缓存和全文搜索 - Redis 是缓存键值对的常见选择。Elasticsearch 用于全文搜索。
- 通信 - 为了让服务彼此通信，我们可以使用消息基础设施 Kafka 或 RPC。
- 持久化 - 我们可以使用 MySQL 或 PostgreSQL 作为关系型数据库，Amazon S3 作为对象存储。如果需要，我们也可以使用 Cassandra 作为宽列存储。
- 管理和监控 - 为了管理这么多微服务，常用的运维工具包括Prometheus、Elastic Stack和Kubernetes。


### kafka-为什么快

有许多设计决策为Kafka的性能做出了贡献。在本文中，我们将专注于其中的两个。我们认为这两个决策起到了最大的作用。
<p>
  <img src="images/why_is_kafka_fast.jpeg" />
</p>

1. 第一个决策是Kafka对顺序I/O的依赖。
2. 第二个决策让Kafka拥有性能优势的是其专注于效率：零拷贝原则。

下图说明了生产者和消费者之间的数据传输方式以及零拷贝的含义。

- 步骤1.1-1.3：生产者将数据写入磁盘
- 步骤2：消费者在没有零拷贝的情况下读取数据

2.1 数据从磁盘加载到操作系统缓存中

2.2 数据从操作系统缓存中复制到Kafka应用程序中

2.3 Kafka应用程序将数据复制到套接字缓冲区中

2.4 数据从套接字缓冲区中复制到网络卡中

2.5 网络卡将数据发送给消费者

- 步骤3：消费者使用零拷贝读取数据

3.1：数据从磁盘加载到操作系统缓存中
3.2 操作系统缓存通过sendfile()命令直接将数据复制到网络卡中
3.3 网络卡将数据发送给消费者

零拷贝是一种节省应用程序上下文和内核上下文之间多次数据复制的快捷方式。